{% extends "base.html" %}
{% block title %}Applications • JobBoard{% endblock %}
{% block content %}
<div class="d-flex align-items-center justify-content-between mb-3">
  <div>
    <h1 class="h4 mb-1">All Applications</h1>
    <div class="text-muted">Applications across your jobs{% if employer and employer.company_name %} • {{ employer.company_name }}{% endif %}</div>
  </div>
  <a class="btn btn-outline-secondary btn-sm" href="{% url 'employer_jobs' %}">My jobs</a>
</div>

<div class="card p-3 mb-3">
  <div class="d-flex flex-wrap align-items-center gap-2">
    <span class="text-muted small">Filter:</span>
    <ul class="nav nav-pills">
      <li class="nav-item">
        <a class="nav-link {% if status == 'all' %}active{% endif %}" href="?status=all">All <span class="badge bg-light text-dark ms-1">{{ counts.all }}</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link {% if status == 'submitted' %}active{% endif %}" href="?status=submitted">Submitted <span class="badge bg-light text-dark ms-1">{{ counts.submitted }}</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link {% if status == 'interview' %}active{% endif %}" href="?status=interview">Interview <span class="badge bg-light text-dark ms-1">{{ counts.interview }}</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link {% if status == 'rejected' %}active{% endif %}" href="?status=rejected">Rejected <span class="badge bg-light text-dark ms-1">{{ counts.rejected }}</span></a>
      </li>
    </ul>
  </div>
</div>

{% if applications %}
  <div class="card p-3">
    <div class="table-responsive">
      <table class="table align-middle mb-0">
        <thead>
          <tr>
            <th>Job</th>
            <th>Candidate</th>
            <th>Status</th>
            <th>Submitted</th>
            <th>Interview</th>
            <th>Resume</th>
            <th class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for a in applications %}
            <tr>
              <td style="min-width: 240px;">
                <a class="text-decoration-none" href="{% url 'job_detail' a.job.id %}">
                  <strong>{{ a.job.title }}</strong>
                </a>
                <div class="text-muted small">{{ a.job.location }}</div>
              </td>
              <td style="min-width: 200px;">
                <strong>{{ a.jobseeker.user.username }}</strong>
                {% if a.jobseeker.full_name %}<div class="text-muted small">{{ a.jobseeker.full_name }}</div>{% endif %}
              </td>
              <td>
                {% if a.status == 'submitted' %}
                  <span class="badge bg-primary">Submitted</span>
                {% elif a.status == 'interview' %}
                  <span class="badge bg-warning text-dark">Interview</span>
                {% elif a.status == 'rejected' %}
                  <span class="badge bg-danger">Rejected</span>
                {% else %}
                  <span class="badge bg-secondary">{{ a.status }}</span>
                {% endif %}
              </td>
              <td class="text-muted">{{ a.submitted_at|date:"Y-m-d H:i" }}</td>
              <td class="text-muted">
                {% if a.interview_date %}
                  {{ a.interview_date|date:"Y-m-d" }}{% if a.interview_time %} {{ a.interview_time|time:"H:i" }}{% endif %}
                {% else %}
                  —
                {% endif %}
              </td>
              <td>
                {% if a.resume %}
                  <a href="{{ a.resume.url }}" target="_blank" rel="noopener">Download</a>
                {% else %}
                  —
                {% endif %}
              </td>
              <td class="text-end">
                <div class="d-inline-flex gap-2">
                  <a class="btn btn-outline-primary btn-sm" href="{% url 'application_detail' a.id %}?next={{ request.get_full_path|urlencode }}">Details</a>
                  <a class="btn btn-outline-secondary btn-sm" href="{% url 'schedule_interview' a.id %}?next={{ request.get_full_path|urlencode }}">Schedule</a>
                  {% if a.status != 'rejected' %}
                    <a class="btn btn-outline-danger btn-sm" href="{% url 'reject_application' a.id %}?next={{ request.get_full_path|urlencode }}">Reject</a>
                  {% endif %}
                </div>
              </td>
            </tr>
            {% if a.cover_letter %}
              <tr>
                <td colspan="7" class="bg-light">
                  <div class="small text-muted mb-1">Cover letter</div>
                  <div style="white-space: pre-wrap;">{{ a.cover_letter }}</div>
                </td>
              </tr>
            {% endif %}
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
{% else %}
  <div class="card p-4">
    <p class="mb-0">No applications yet.</p>
  </div>
{% endif %}

{% if page_obj and page_obj.paginator.num_pages > 1 %}
  <nav class="mt-3">
    <ul class="pagination justify-content-center">
      {% if page_obj.has_previous %}
        <li class="page-item"><a class="page-link" href="?status={{ status|urlencode }}&page={{ page_obj.previous_page_number }}">Prev</a></li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">Prev</span></li>
      {% endif %}
      <li class="page-item disabled"><span class="page-link">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span></li>
      {% if page_obj.has_next %}
        <li class="page-item"><a class="page-link" href="?status={{ status|urlencode }}&page={{ page_obj.next_page_number }}">Next</a></li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">Next</span></li>
      {% endif %}
    </ul>
  </nav>
{% endif %}
{% endblock %}
