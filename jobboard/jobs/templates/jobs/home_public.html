{% extends "base.html" %}
{% block title %}JobBoard • Find jobs like Indeed{% endblock %}
{% block content %}

<div class="hero p-4 p-lg-5 rounded-4 mb-4">
  <div class="row g-4 align-items-center">
    <div class="col-lg-7">
      <h1 class="display-6 fw-semibold mb-2">Find your next job</h1>
      <p class="lead mb-3 text-muted">Search jobs, track applications, and manage hiring — all in one place.</p>

      <form class="row g-2" method="get" action="{% url 'job_list' %}">
        <div class="col-md-7">
          <input class="form-control form-control-lg" name="q" placeholder="Job title, keyword…" />
        </div>
        <div class="col-md-3">
          <input id="home-skills-input" class="form-control form-control-lg" name="skills" placeholder="Skills (optional)" autocomplete="off" />
        </div>
        <div class="col-md-2 d-grid">
          <button class="btn btn-primary btn-lg" type="submit">Search</button>
        </div>
        <div class="col-12">
          <div id="home-skill-suggestions" class="d-flex flex-wrap gap-1 mt-1">
            {% for s in hero_skill_suggestions %}
              <button type="button" class="btn btn-outline-secondary btn-sm py-0 px-2 js-home-skill" data-skill="{{ s }}">{{ s }}</button>
            {% endfor %}
          </div>
        </div>
      </form>

      <div class="d-flex flex-wrap gap-3 mt-3 text-muted small">
        <span><strong>{{ stats.jobs }}</strong> jobs</span>
        <span><strong>{{ stats.companies }}</strong> companies</span>
        {% if stats.show_applications %}
          <span><strong>{{ stats.applications }}</strong> applications</span>
        {% endif %}
      </div>
    </div>

    <div class="col-lg-5">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <div class="fw-semibold mb-2">Featured companies</div>
          <div class="row g-2">
            {% for c in featured_companies %}
              <div class="col-6">
                <a class="mini-company card card-body p-2 text-decoration-none text-body" href="{% url 'job_list' %}?company={{ c.company_name|urlencode }}">
                  <div class="fw-semibold small text-truncate">{{ c.company_name }}</div>
                  <div class="text-muted small">{{ c.jobs_count }} jobs</div>
                </a>
              </div>
            {% empty %}
              <div class="text-muted small">No companies yet.</div>
            {% endfor %}
          </div>
          <div class="mt-3">
            {% if user.is_authenticated and user.role == 'employer' %}
              <a class="btn btn-outline-primary w-100" href="{% url 'create_job' %}">Post a job</a>
            {% elif user.is_authenticated and user.role == 'jobseeker' %}
              <a class="btn btn-outline-primary w-100" href="{% url 'my_applications' %}">My applications</a>
            {% else %}
              <div class="d-grid gap-2">
                <a class="btn btn-primary" href="{% url 'register_jobseeker' %}">Join as job seeker</a>
                <a class="btn btn-outline-secondary" href="{% url 'register_employer' %}">Hire talent</a>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<h2 class="h5 mb-3">Latest jobs</h2>
{% if recent_jobs %}
  <div class="row g-3">
    {% for job in recent_jobs %}
      <div class="col-lg-4 col-md-6 col-12">
        <div class="card h-100 job-card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start gap-2">
              <div>
                <h3 class="h6 mb-1">
                  <a class="stretched-link text-decoration-none" href="{% url 'job_detail' job.id %}">{{ job.title }}</a>
                </h3>
                <div class="text-muted small">{{ job.employer.company_name }} • {{ job.location }}</div>
              </div>
              <span class="badge bg-light text-dark border">{{ job.get_job_type_display }}</span>
            </div>
            <p class="mt-2 mb-0 text-muted small">{{ job.description|truncatechars:120 }}</p>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
  <div class="mt-3">
    <a class="btn btn-outline-secondary" href="{% url 'job_list' %}">View all jobs</a>
  </div>
{% else %}
  <div class="card p-4">No jobs yet.</div>
{% endif %}

<script>
  (function () {
    const input = document.getElementById("home-skills-input");
    const box = document.getElementById("home-skill-suggestions");
    if (!input || !box) return;

    function addSkill(skill) {
      const parts = (input.value || "").split(",").map((p) => p.trim()).filter(Boolean);
      if (!parts.some((p) => p.toLowerCase() === skill.toLowerCase())) {
        parts.push(skill);
      }
      input.value = parts.join(", ");
      input.focus();
    }

    function render(items) {
      box.innerHTML = "";
      items.forEach((item) => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "btn btn-outline-secondary btn-sm py-0 px-2";
        btn.textContent = item;
        btn.addEventListener("click", () => addSkill(item));
        box.appendChild(btn);
      });
    }

    async function refresh() {
      const parts = (input.value || "").split(",");
      const q = (parts[parts.length - 1] || "").trim();
      try {
        const res = await fetch("{% url 'skill_suggestions_api' %}?q=" + encodeURIComponent(q));
        if (!res.ok) return;
        const data = await res.json();
        if (Array.isArray(data.items)) render(data.items);
      } catch (err) {}
    }

    box.querySelectorAll(".js-home-skill").forEach((btn) => {
      btn.addEventListener("click", () => addSkill(btn.dataset.skill || btn.textContent || ""));
    });
    input.addEventListener("input", refresh);
  })();
</script>

{% endblock %}
